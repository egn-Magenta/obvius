<!-- Form doctype: -->
%if($output->param('flush_xml')) {
<& form_files/flush_xml, %ARGS &>
%} else {

%if($prefix) {
%   my $uri2 = $uri;
%   $uri2 =~ s!/$!!;
<div class="obviusformdownload">
    <div><a href="<% $prefix . $uri2 %>?get_file=1"><& /shared/msg, text=>"Click here to download collected form data in XML format" &></a>.</div>
    <div><a href="<% $prefix . $uri2 %>?get_file=1&format=excel"><& /shared/msg, text=>"Click here to download collected form data in Excel format" &></a>.</div>
    <br />
    <div><a href="<% $prefix . $uri %>?flush_xml=1"><& /shared/msg, text=>"Flush XML file" &></a></div>
</div>
%}

<& headline &>
%
%if($r->param('obvius_form_submitted') and $output->param('submitted_data_ok')) {
<& form_files/after_submit, %ARGS, output=>$output &>
%} else {
<& teaser &>

<& /shared/htmlize, text=>$vdoc->field('formtext') || '' &>

<div class="obviusform">

%if(scalar(@$invalid)) {
<div class="error">
Der var fejl i indtastningen af følgende felter. Klik på feltnavnet for at rette feltet i formularen nedenfor.
<ul>
%for(@$invalid) {
    <li><a href="#<% $_ %>"><% $fields_by_name{$_}->{title} %></a></li>
%}
</ul>
</div>
<br />
%}

%$r->notes('fieldsets' => 0);
%unless($prefix) {
<form name="pageform" action="<% $uri %>" method="get">
%}
<input type="hidden" name="obvius_form_submitted" value="1" />
%for(@$fields) {
%unless($_->{type} eq 'fieldset') {
<label for="<% $_->{name} %>">
<a name="<% $_->{name} %>"></a>
<% $_->{title} %><% ($_->{mandatory}) eq '1' ? ' <span class="mandatory">*</span>' : '' %>
%}
%if($_->{invalid}) {
<p class="error">
Fejl: <% $_->{invalid} %>
</p>
%}
%if($_->{mandatory_failed}) {
<& Form:show_mandatory_error, field=>$_, fields_by_name=>\%fields_by_name &>
%}
%   if($m->comp_exists('form_files/fieldtypes/' . $_->{type})) {
    <& 'form_files/fieldtypes/' . $_->{type}, fielddata=>$_ &>
%   } else {
    <& 'form_files/fieldtypes/default', fielddata=>$_ &>
%   }
%   unless($_->{type} eq 'fieldset') {
    <br />
</label>
%   }
%}
%if($r->notes('fieldsets')) {
</fieldset>
%}

<br />
<div>
<input type="submit" value="Send" />
Felter markeret med <span class="mandatory">*</span> skal udfyldes.
</div>
%unless($prefix) {
</form>
%}
</div>
%
%}
%
%}
%
<!-- /Form Doctype -->
<%args>
$output
</%args>
%
<%init>
$obvius->get_version_fields($vdoc, ['formtext']);
my $formdata = $output->param('formdata');
my $fields = $formdata->{field} || [];

my $invalid = $output->param('invalid') || [];

my %fields_by_name = map { $_->{name} => $_ } @$fields;
</%init>
<%once>
use Unicode::String qw(utf8 latin1);
</%once>
%
%
%
<%method show_mandatory_error>
<%args>
$field
$fields_by_name
</%args>
<p class="error">
%if($field->{mandatory} eq "1") {
    Fejl: feltet skal udfyldes.
%} else {
%    if($field->{mandatory} =~ s/^!//) {
        Fejl: feltet skal udfyldes hvis feltet "<% $fields_by_name->{$field->{mandatory}}->{title} %>" ikke er udfyldt.
%    } else {
        Fejl: feltet skal udfyldes hvis feltet "<% $fields_by_name->{$field->{mandatory}}->{title} %>" er udfyldt.
%    }
%}
</p>
</%method>
