%if($mail_error) {
<p>
    Der opstod en fejl under registreringen af dine indtastninger:<br />
    <strong><% $mail_error %></strong>
</p>
%} else {
<& /shared/htmlize, text=>$vdoc->field('aftersubmittext') &>
%}
<%args>
$output
</%args>
<%init>
my $mail_error;
$obvius->get_version_fields($vdoc, ['aftersubmittext', 'mailto']);

if(my $mailto = $vdoc->field('mailto')) {
    my $mailtxt = $m->scomp('mail/formdata.txt', mailto=>$mailto, output=>$output);

    $mail_error = "Kunne ikke generere mail besked" unless($mailtxt);

    my $smtp = Net::SMTP->new('localhost', Timeout=>30, Debug => 1);
    my $from = $r->notes('formdata_mail_from') || $mailto;

    $mail_error = "Failed to specify a sender [$from]\n"        unless ($mail_error or $smtp->mail($from));
    $mail_error = "Failed to specify a recipient [$mailto]\n"   unless ($mail_error or $smtp->to($mailto));
    $mail_error = "Failed to send a message\n"                  unless ($mail_error or $smtp->data([$mailtxt]));
    $mail_error = "Failed to quit\n"                            unless ($mail_error or $smtp->quit);

}
</%init>