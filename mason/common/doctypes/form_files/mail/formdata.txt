To: <% $mailto %>
From: <% $from %>
Subject: Udfyldt formular: <% $vdoc->field('title') %> (http://<% $obvius->config->param('roothost') %>/admin<% $r->uri %>)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Transfer-Encoding: 8bit
Content-Disposition: inline
Precedence: bulk

Formularen "<% $vdoc->field('title') %>" er blevet udfyldt med følgende data:

%for(@$fields) {
%next if($_->{type} =~ m!^fieldset!);
<% $_->{title} %> (<% $_->{name} %>):
%if(ref($_->{_submitted_value})) {
<% utf8(join(", ", @{ $_->{_submitted_value} }))->latin1 %>
%} else {
<% utf8($_->{_submitted_value})->latin1 %>
%}

%}

-- Start csv data --
<% join(";", @csv_values) %>
-- End csv data --

--
  <% $obvius->config->param('sitename') %>
%
%
%
<%args>
$output
$mailto
</%args>
%
%
<%init>
my $formdata = $output->param('formdata');

my $fields = $formdata || [];
my %fields_by_name = map { $_->{name} => $_ } @$fields;


my $from = $obvius->config->param('mail_from_address') || 'noreply@adm.ku.dk';

# Try to make the mail originate from whoever filled the
# form. Magic fieldnames used are "email" and "name".
if($fields_by_name{'name'}->{_submitted_value} and $fields_by_name{'email'}->{_submitted_value}) {
    $from = $fields_by_name{'name'}->{_submitted_value} . " <" . $fields_by_name{'email'}->{_submitted_value} . ">";
    $r->notes('formdata_mail_from' => $fields_by_name{'email'}->{_submitted_value})
} elsif($fields_by_name{'email'}) {
    $from = $fields_by_name{'email'}->{_submitted_value};
    $r->notes('formdata_mail_from' => $fields_by_name{'email'}->{_submitted_value})
}

my @csv_values;

for(@$fields) {
    next if($_->{type} =~ m!^fieldset!);
    my $val;
    if(ref($_->{_submitted_value})) {
        $val = join("|", @{$_->{_submitted_value}});
    } else {
        $val = $_->{_submitted_value} || '';
    }
    # Only documentation on windows CSV I could find said to use
    # ~ for linebreaks.
    $val =~ s!\r?\n!~!g;
    $val =~ s|;||g;
    
    $val = utf8($val)->latin1;
    push(@csv_values, $val);
}

my $url_sitename = $obvius->config->param('test_sitename') || $obvius->config->param('sitename');
</%init>
<%once>
use Unicode::String qw(utf8 latin1);
use Encode;
</%once>
<%filter>
# Cleanup utf characters
$_ =~ s/(Ã.)/utf8($1)->latin1/ge;
</%filter>
%
%
