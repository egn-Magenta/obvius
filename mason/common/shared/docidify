<% $out %>\
<%args>
$html
</%args>
<%init>
$out = '';
$p->parse($html);
$p->eof;
$m->scomp( '/shared/from_utf8', dataref => \$out);
</%init>
<%once>
# $out should be reset before parsing.
my $out='';
my $hostname_from_req = $r->hostname;
my $p = HTML::Parser->new(api_version=>3,
                            default_h=> [ sub { my($this, $text)=@_; $out.=$text }, "self, text" ],
                            start_h=> [sub {
                                                my($this, $tagname, $text, $attr)=@_;
                                                if($tagname eq 'a' and $attr->{href}) {

                                                    # Make urls relative to / and convert to .docid format if possible:

                                                    my $uri = $attr->{href};
                                                    my $org_uri = $uri;

                                                    if($uri) {
                                                        $uri =~ s!^http://$hostname_from_req/!/!;
                                                        $uri =~ s!^/admin/!/!;

                                                        if($uri =~ m!^/!) {
                                                            # Remove anchor ref and querystring:
                                                            $uri =~ s!#.*$!!;
                                                            $uri =~ s!\?.*$!!;

                                                            if(my $doc = $obvius->lookup_document($uri)) {
                                                                # Remove anchor and querystring from original uri:
                                                                $org_uri =~ s!#.*$!!;
                                                                $org_uri =~ s!\?.*$!!;

                                                                $uri = "/" . $doc->Id . ".docid";
                                                                $text =~ s!\Q$org_uri\E!$uri!;
                                                            }
                                                        }
                                                    }

                                                    $out.=$text;

                                                } elsif($tagname eq 'img' || $tagname eq 'embed') {

                                                    # Make images relative to / and convert to .docid format if possible:

                                                    my $org_src = $attr->{src};

                                                    if($org_src) {
                                                        # Remove achor and querystring:
                                                        $org_src =~ s!#.*$!!;
                                                        $org_src =~ s!\?.*$!!;

                                                        my $src = $org_src;

                                                        # Remove hostname:
                                                        $src =~ s!^http://$hostname_from_req/!/!;
                                                        $src =~ s!^/admin/!/!;


                                                        if($src =~ m!^/!) {
                                                            if(my $imgdoc = $obvius->lookup_document($src)) {
                                                                $src = "/" . $imgdoc->Id . ".docid";
                                                            }
                                                        }

                                                        $text =~ s!\Q$org_src\E!$src!;
                                                    }

                                                    $out .= $text;
                                                } elsif($tagname eq 'object' and $attr->{type} and $attr->{type} eq 'application/x-shockwave-flash') {
                                                    my $org_path = $attr->{data};
                                                    if($org_path) {
                                                        my ($docid_url, $replace) = $m->comp('docidify:url2docid', url=>$org_path);
                                                        if($docid_url) {
                                                            $text =~ s!\Q$replace\E!$docid_url!;
                                                        }
                                                    }
                                                    $out .= $text;
                                                } elsif($tagname eq 'param' and $attr->{name} and ($attr->{name} eq 'movie' or $attr->{name} eq 'src')) {
                                                    my $org_path = $attr->{value};
                                                    if($org_path) {
                                                        my ($docid_url, $replace) = $m->comp('docidify:url2docid', url=>$org_path);
                                                        if($docid_url) {
                                                            $text =~ s!\Q$replace\E!$docid_url!;
                                                        }
                                                    }
                                                    $out .= $text;
                                                } else {
                                                    $out.=$text;
                                                }
                                                }, "self, tagname, text, attr" ],
                            end_h=> [sub {
                                            my($this, $tagname, $text, $attr)=@_;
                                            $out.=$text;
                                        }, "self, tagname, text, attr" ],
                            text_h=> [ sub {
                                        my ($this, $text)=@_;
                                        $out.=$text;
                                        },
                                        "self, text" ]);
$p->attr_encoded(1); # Don't decode entities in attributes
</%once>
<%method url2docid>
<%args>
$url
</%args>
<%init>
# Remove achor and querystring:
$url =~ s!#.*$!!;
$url =~ s!\?.*$!!;

# This is the part of the URL we want to replace with /<docid>.docid. Save it.
my $replace_part = $url;

# Remove hostname:
$url =~ s!^http://$hostname_from_req/!/!;
# and /admin/:
$url =~ s!^/admin/!/!;


if($url =~ m!^/!) {
    if(my $doc = $obvius->lookup_document($url)) {
        $url = "/" . $doc->Id . ".docid";
        return ($url, $replace_part);
    }
}
return undef;
</%init>
</%method>
