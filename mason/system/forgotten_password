<html>
<head>
<title>
  <& translator, da => "Forgotten password",       
                 en => "Glemt adgangskode" &>
</title>
<style type="text/css">
label {
  float: left;
  width: 9em;
};
</style>
</head>
<body>
<div>
  <h2>FÃ¥ tilsendt ny adgangskode</h2>
  <div style="color: <% $error_color %>">
    <h3><% $error |h %></h2>
  </div>
      
  <form action="<% $r->uri |h %>" method="post" />
  <label for="user">
    <& translator, da => "Brugernavn:",
                   en => "Username:" &>
  </label>
  <input type="text" name="user" id="user" value="<% $user |h %>"/><br />
  <label for="email">
    <& translator, da => "Emailadresse:",
                   en => "Email address:" &>
  </label>
  <input type="text" name="email" id="email" value="<% $email |h %>" /><br />
  <input type="hidden" name="came_from" value="<% $came_from |h %>" />
  <input type="submit" 
         name="form_submitted"
         value="<& translator, da => 'Jeg har glemt min adgangskode',
                               en => 'I have forgotten my password' &>" />

% if ($came_from) {
  <input type="button"
         value="<& translator, da => 'Tilbage til login', en => 'Back to login' &>"
         onclick="window.location.href='<% $came_from |h %>'" />
% }
</div>  
</body>
</html>
<%args>
$email => undef
$user => undef
$form_submitted => undef
$came_from => undef
</%args>
<%init>
use Digest::MD5 qw(md5_base64);
use Obvius;
use Obvius::Config;
use WebObvius::Cache::Cache;

my $error;
my $error_color = "red";
my $set_error = sub {
     $error = $_[0] || $m->scomp("translator", da => "Ugyldig input", en => "Illegal input");
     $error_color = $_[1];
};

my $obvius = Obvius->new(Obvius::Config->new('ku'));
$obvius->read_user_and_group_info;

if ($form_submitted) {
     if ($user eq 'admin') {
          $set_error->();
          goto end;
     }

     my $user = $obvius->{USERS}{$user};
     if (!$user) {
          $set_error->();
          goto end;
     }
     
     if ($user->{email} ne $email) {
          $set_error->();
          goto end;
     }
     
     my $random = rand;
     $random .= rand for (0..100);

     my $password = substr(md5_base64($random), 14); 
     $obvius->{USER} = $user->{login};
     $user->{password} = $password;
     
     if (!$obvius->update_user_passwd($user)) {
          $set_error->($m->scomp("translator", da => "Intern fejl", en => "Internal error"));
          goto end;
     }

     # Clear cache for changes to be visible immediately
     my $cache = WebObvius::Cache::Cache->new($obvius);
     $cache->find_and_flush($obvius->modified);
  
     my $msg =<<END;
To: $email
From: noreply\@adm.ku.dk
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Subject: Ny adgangskode for bruger $user->{login}

Adgangskode for bruger $user->{login} er nu: $password
END
     $obvius->send_mail($email, $msg, 'noreply@adm.ku.dk');
    $set_error->($m->scomp("translator", 
                           da => "Vi har mailet din nye adgangskode til dig", 
                           en => "Your password has been emailed to you."), 'blue');
}
end:
</%init>
          
